---
title: "epid 722 recitation, 2016/01/25"
author: "epid 722 2016"
date: "January 22, 2016"
output: 
  html_document:
   toc: true
   toc_depth: 2
   theme: united
   number_sections: true
---

**NOTE: ALL SAS and R code below copied from EPID 700 Fall 2015 class by Xiaojuan Li (L25_R Data management.pdf)**

```{r, echo=F, message=FALSE}
require(knitr)
require(foreign)
#install.packages("sandwich")
require(sandwich)
set.seed(123) # set seed so you get same results each time you run.
```

<!-- # Read in SAS code to insert later in this document. Note: this won't work if there are any errors in the SAS code.-->

```{r, echo=F, cache=FALSE}
read_chunk('C:\\Users\\chelo\\Dropbox\\unc.grad.school.2016.spring\\epid.722\\2016\\recitation\\sample-intro.sas')
```

## Simulate data object in R, exdat, and export to .csv file

```{r}
N <-50 
var4 <-rnorm(n=N, mean=0, sd=1)
var5 <-rnorm(N, 1.2*var4+1, 2)
var1 <-rbinom(N, 1, 0.4 + 0.1*var4)
var3 <-rbinom(N, 1, 0.4 + 0.1*var5)
var2 <-ifelse(var3==1,"female","male")

exdat = data.frame(var1=var1,
                   var2=var2,
                   var3=var3,
                   var4=var4,
                   var5=var5)
summary(exdat)

# see http://sas-and-r.blogspot.com/2009/08/example-710-get-data-from-r-into-sas.html
write.dbf(exdat, "c:/temp/exdat.dbf") # note: skipped .csv export because of missing values
```

## Reading and printing

### SAS code

```{r sasread1, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=T, warning=FALSE, eval=T}
```

### R code

```{r}
exdat[1:10,] # R is object based, uses matrix notation
head(exdat, n=10) # print first 10 rows of data
tail(exdat, n=5) # print last 5 rows of data
exdat # print all
```

## Understanding a data structure

### SAS code
```{r section1, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=T, message=F, warning=FALSE, eval=T}
```


### R code
```{r}
str(exdat) # find out information about an object or data structure
```

## Example: adding or deleting a column

### SAS code
```{r section2, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=F}
```

### R code

```{r}
# adding a column to a data frame
exdat$newcol <- NA #assign a single value to the new col
exdat$newcol1 <- NA #assign a single value to the new col
exdat$d <- "d" #assign a new vector
# deleting a column from a data frame
exdat$d <- NULL
#exdat <-subset(exdat, select= -newcol)
exdat <-subset(exdat, select= c(-newcol, -newcol1))
```

## Example: subsetting data

### SAS code
```{r section3, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code

```{r}
exdat1 <- subset(exdat, var1 >=10)
exdat1 <- exdat[exdat$var1 >=10]
# to add more selection criteria
exdat2 <- subset(exdat, var1 >=10 & var2 == "female", select=c(var1, var2, var3))
```


## Example: reordering columns

### SAS code
```{r section4, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code
```{r}
exdat <- exdat[c("var4", "var1", "var2", "var3")] # reorder by column name
exdat <- exdat[c(4, 1, 2, 3)] # reorder by numeric position
```


## Example: creating a frequency table

### SAS code
```{r section5, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code
```{r}
mytable <- table(exdat$var1) # 1-way frequency table
mytable1 <- table(exdat$var1, exdat$var2); mytable1 # 2-way frequency table
margin.table(mytable1, 1) # row freq
margin.table(mytable1, 2) # col freq
(mytable1 <- table(exdat$var1, exdat$var2, exclude=NULL)) # include NA as a category
(mytable2 <- table(exdat$var1, exdat$var2, exdat$var3)) # 3-way frequency table
```

## Example: recoding a categorical variable to another categorical variable

### SAS code
```{r section6, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code
```{r}
oldvals <- c('female', 'male')
newvals <- factor(c('yes', 'no'))
exdat1$female <- newvals[ match(exdat$var2, oldvals) ]
# or this
exdat1$female[exdat$var2 =='female'] <- 'yes'
exdat1$female[exdat$var2 =='male'] <- 'no'
```

## Example: recoding a continuous variable to a categorical variable

### SAS code
```{r section7, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code
```{r}
summary(exdat$var3)
exdat2 = exdat
exdat2$var3cat <- cut(exdat$var3, breaks = c(0, 0.5, 0.6,Inf),
                      labels =c("small", "medium", "large"))
```

## Example: logistic regression

### SAS code
```{r section8, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=FALSE}
```

### R code
```{r}
glm(var1 ~ var2 + var3, data=exdat, family=binomial(link="logit"))
# change family and link for other regressions
```

## Example: Poisson regression with robust standard errors

### SAS code
```{r section9, engine='sas', engine.path='C:\\Program Files\\SASHome\\SASFoundation\\9.4\\sas.exe', results='markup', echo=TRUE, cache=FALSE, warning=FALSE, eval=F}
```

### R code
```{r}
m1 <- glm(var1 ~ var2 + var3, family="poisson", data=exdat)
library(sandwich)
cov.m1 <- vcovHC(m1, type="HC0")
std.err <- sqrt(diag(cov.m1))
r.est <- cbind(Estimate= coef(m1), 
               "Robust SE" = std.err,
               "Pr(>|z|)" = 2 * pnorm(abs(coef(m1)/std.err), 
                                      lower.tail=FALSE),
LL = coef(m1) - 1.96 * std.err,
UL = coef(m1) + 1.96 * std.err)
r.est
```